sudo apt install jq awscli
iid=`curl http://169.254.169.254/latest/meta-data/instance-id`
source setup # set environment variables, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_DEFAULT_REGION

# Get tags
aws --region us-east-1 ec2 describe-tags --filters Name=resource-id,Values=$iid 
# aws --region us-east-1 ec2 describe-tags --filters Name=resource-id,Values=$iid "Name=tag:created_by,Values='*'"  | jq
'.Tags[] | {Value} | join (" ")'

# If have valid credentials can do
aws ec2 describe-instance-attribute --instance-id $iid --attribute groupSet


# Create security group allowing VPC wide http access to this instance
# Get the VPC main CIDR
myip=`curl http://169.254.169.254/latest/meta-data/local-ipv4`
aws ec2 describe-network-interfaces --filters Name=addresses.private-ip-address,Values=${myip}
vpcid=`aws ec2 describe-network-interfaces --filters Name=addresses.private-ip-address,Values=${myip} | grep VpcId |  awk '{print $2}' | tr -d '"' `
vpccidr=`aws ec2 describe-vpcs --filters Name=vpc-id,Values=${vpcid}  | grep CidrBlock\" | head -1 | awk '{print $2}' | tr -d '",' `

# Create security rule to allow ingress on http ports from inside CIDR
aws ec2 create-security-group --group-name "core-admin-allow-vpc-internal-http-ingress" --description "SG to allow internal http ingress from with VPC"
aws ec2 describe-security-groups --filters Name=group-name,Values="core-admin-allow-vpc-internal-http-ingress"
sgid=`aws ec2 describe-security-groups --filters Name=group-name,Values="core-admin-allow-vpc-internal-http-ingress" | grep GroupId | awk '{print $2}' | tr -d '",'`

# Add the rule to the instance (need to include existing security groups)
cursglist=`curl http://169.254.169.254/latest/meta-data/security-groups | tr "\n" ","`
sgid0=`aws ec2 describe-security-groups --filters Name=group-name,Values=${cursglist} | grep GroupId | awk '{print $2}' | tr -d '",' | tr "\n" "," | sed s'/,$//' | tr "," " "`
aws ec2 modify-instance-attribute --instance-id ${iid} --groups $sgid0 $sgid

# Just for fun read user data
aws ec2 describe-instance-attribute --instance-id $iid --attribute userData | grep Value | awk '{print $2}' | tr -d '"' | base64 -d
